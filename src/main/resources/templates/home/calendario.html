<!DOCTYPE html>
<html>
<head>
<meta name="viewport"
	content="width=device-width, height=device-height, initial-scale=1.0, minimum-scale=1.0">
<meta charset="UTF-8" />
<title>Home</title>
<link rel="stylesheet"
	href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
	integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
	crossorigin="anonymous">

<link rel="stylesheet" type="text/css"
	href="https://unpkg.com/js-year-calendar@latest/dist/js-year-calendar.min.css" />
<link rel="stylesheet" type="text/css" th:href="@{styles/style.css}" />
<link rel="stylesheet" type="text/css" th:href="@{css/calendario.css}" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">


<script src="https://kit.fontawesome.com/33a002ef8f.js"
	crossorigin="anonymous"></script>
</head>
<body>
	<!-- NavBar START -->
	<div th:insert="fragments/navbar :: navbar" class="sticky-top"></div>
	<!-- NavBar END -->
	<th:block th:include="fragments/navbar :: modals"></th:block>
	<!-- Bootstrap row -->
	<div class="row" id="body-row">
		<!-- Sidebar START -->
		<div th:replace="fragments/navbar :: sidebar" style="background-color: red;"></div>
		<!-- Sidebar END -->
		<!-- MAIN -->
		<div class="col padding-especial">
			<main class="container-fluid">
				<div class="row">
				<div class="col">
					<div id="calendar" ></div>
					
				</div>
					<div class="modal fade" id="event-modal">
						<div class="modal-dialog">
							<div class="modal-content">
								<div class="modal-header">
									<h5 class="modal-title">Nueva Reserva</h5>
									<button type="button" class="close" data-dismiss="modal"
										aria-label="Close">
										<span aria-hidden="true">&times;</span>
									</button>
								</div>
								<div class="modal-body">
									<input type="hidden" name="event-index">
									<form class="form-horizontal" th:action="@{/aÃ±adirReserva}" method="POST">
										<div class="form-group row">
											<label for="casa" class="col-sm-4 control-label">Vivienda</label>
											<div class="col-sm-8">
												<select class="form-control" id="casa" name="casa">
													<option th:each="i :${user}"
														th:value="${i.getCodVivienda()}" th:text="${i.getNombre()}"></option>
												</select>
											</div>
										</div>
										<div class="form-group row">
											<label for="price" class="col-sm-4 control-label">Precio</label>
											<div class="col-sm-8">
												<input id="price" name="price" type="number"
													class="form-control" value="0">
											</div>
										</div>
										<div class="form-group row">
											<label for="min-date" class="col-sm-4 control-label">Dates</label>
											<div class="col-sm-8">
												<div class="input-group input-daterange"
													data-provide="datepicker">
													<input id="min-date" name="event-start-date" type="text"
														class="form-control">
														
													<div class="input-group-prepend input-group-append">
														<div class="input-group-text">to</div>
													</div>
													<input name="event-end-date" type="text"
														class="form-control">
												</div>
											</div>
										</div>
									
								</div>
								<div class="modal-footer">
									<button type="button" class="btn btn-default"
										data-dismiss="modal">Cancel</button>
									<button type="submit" class="btn btn-primary" id="save-event">
										Save</button>
								</div>
								</form>
							</div>
						</div>
					</div>
					<div id="context-menu"></div>
				</div>
			</main>
		</div>
		<!-- Main Col END -->
	</div>
	<!-- body-row END -->
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script th:inline="javascript">
/*<![CDATA[*/
let calendar = null;

function editEvent(event) {
    $('#event-modal input[name="event-index"]').val(event ? event.id : '');
    $('#event-modal input[name="event-name"]').val(event ? event.name : '');
    $('#event-modal input[name="event-location"]').val(event ? event.location : '');
    $('#event-modal input[name="event-start-date"]').datepicker('update', event ? event.startDate : '');
    $('#event-modal input[name="event-end-date"]').datepicker('update', event ? event.endDate : '');
    $('#event-modal').modal();
}

function deleteEvent(event) {
    var dataSource = calendar.getDataSource();
    
    calendar.setDataSource(dataSource.filter(item => item.id == event.id));
}

function saveEvent() {
	
    var event = {
        id: $('#event-modal input[name="event-index"]').val(),
        name: $('#event-modal input[name="event-name"]').val(),
        location: $('#event-modal input[name="event-location"]').val(),
        startDate: $('#event-modal input[name="event-start-date"]').datepicker('getDate'),
        endDate: $('#event-modal input[name="event-end-date"]').datepicker('getDate')
    }
    
    var dataSource = calendar.getDataSource();

    if (event.id) {
        for (var i in dataSource) {
            if (dataSource[i].id == event.id) {
                dataSource[i].name = event.name;
                dataSource[i].location = event.location;
                dataSource[i].startDate = event.startDate;
                dataSource[i].endDate = event.endDate;
            }
        }
    }
    else
    {
        var newId = 0;
        for(var i in dataSource) {
            if(dataSource[i].id > newId) {
                newId = dataSource[i].id;
            }
        }
        
        newId++;
        event.id = newId;
    
        dataSource.push(event);
    }
    
    calendar.setDataSource(dataSource);
    $('#event-modal').modal('hide');
}

$(function() {
	$(".table-condensed").css("border", "thick");
    var currentYear = new Date().getFullYear();
 var datos=new Array();
    data=[[${fechas}]];
    for (var d of data){
    	d["endDate"]=new Date(d["endDate"]);
    	d["startDate"]=new Date(d["startDate"]);
    	datos.push(d);
    }
   
    console.log(data);	
    
    console.log(datos);
    calendar = new Calendar('#calendar', { 
    	style: 'background',
    	language: 'es',
        enableContextMenu: true,
        enableRangeSelection: true,
        selectRange: function(e) {
            editEvent({ startDate: e.startDate, endDate: e.endDate });
        },
        mouseOnDay: function(e) {
            if(e.events.length > 0) {
                var content = '';
                
                for(var i in e.events) {
                    content += '<div class="event-tooltip-content">'
                                    + '<div class="event-name" style="color:' + e.events[i].color + '">' + e.events[i].name + '</div>'
                                    + '<div class="event-location">' + e.events[i].location + '</div>'
                                + '</div>';
                }
            
                $(e.element).popover({ 
                    trigger: 'manual',
                    container: 'body',
                    html:true,
                    content: content
                });
                
                $(e.element).popover('show');
            }
        },
        mouseOutDay: function(e) {
            if(e.events.length > 0) {
                $(e.element).popover('hide');
            }
        },
        dayContextMenu: function(e) {
            $(e.element).popover('hide');
        },
        dataSource: datos
    });
    
    $('#save-event').click(function() {
        saveEvent();
    });
});
/*]]>*/
</script>




	<script
		src="https://unpkg.com/js-year-calendar@latest/dist/js-year-calendar.min.js"></script>
	<script
		src="https://unpkg.com/js-year-calendar@latest/locales/js-year-calendar.es.js"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/js/bootstrap-datepicker.min.js"></script>


	<script th:src="@{js/js.js}"></script>


	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
		integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
		crossorigin="anonymous"></script>
	<script
		src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
		integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
		crossorigin="anonymous"></script>
	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.17/dist/css/bootstrap-select.min.css">

	<!-- Latest compiled and minified JavaScript -->
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.17/dist/js/bootstrap-select.min.js"></script>

	<!-- (Optional) Latest compiled and minified JavaScript translation files -->
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.17/dist/js/i18n/defaults-es_ES.min.js"></script>
</body>
</html>